<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnos Pro ICV - MultiGrupo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d32f2f; --whatsapp: #25d366; --bg: #f4f7f6; --card-bg: #ffffff; --text: #333; --border: #eee; }
        body.dark-mode { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --border: #333; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; padding: 10px; color: var(--text); transition: 0.3s; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        
        .profile-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        #profileDisplay { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); background: #eee; }
        .photo-input { position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; font-size: 14px; }
        #file-input { display: none; }

        .logo-icv { max-width: 100px; }
        .brand-name { font-weight: 800; font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 15px; text-transform: uppercase; color: var(--primary); }
        
        .form-group { text-align: left; margin-bottom: 10px; }
        label { font-size: 0.6rem; font-weight: 700; color: #777; display: block; margin-bottom: 3px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px; font-size: 0.9rem; background: var(--card-bg); color: var(--text); }
        
        .config-section { background: #fffde7; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed #fbc02d; }
        body.dark-mode .config-section { background: #332b00; border-color: #fbc02d; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .widget { padding: 8px; background: var(--bg); border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        
        .result-box { margin: 10px 0; padding: 15px; border-radius: 15px; font-weight: 800; font-size: 1.2rem; border: 3px solid transparent; }
        
        .mini-calendar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin: 10px 0; }
        .day-box { padding: 6px; border-radius: 6px; font-size: 0.6rem; font-weight: bold; color: white; }
        
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; }
        .btn-pdf { background-color: #333; }
        .btn-ws { background-color: var(--whatsapp); }

        .footer { margin-top: 15px; font-size: 0.65rem; color: #888; border-top: 1px solid var(--border); padding-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div style="display: flex; justify-content: space-between;">
        <img src="https://www.icv.cl/wp-content/uploads/2021/05/logo-icv.png" alt="ICV" class="logo-icv">
        <button onclick="document.body.classList.toggle('dark-mode')" style="background:none; border:none; cursor:pointer;">ðŸŒ“</button>
    </div>
    
    <div class="profile-container">
        <img id="profileDisplay" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
        <label for="file-input" class="photo-input">+</label>
        <input type="file" id="file-input" accept="image/*" onchange="loadPhoto(event)">
    </div>

    <div class="brand-name">IngenierÃ­a Civil Vicente</div>

    <div class="config-section">
        <div style="display: flex; gap: 8px;">
            <div style="flex: 1;">
                <label>Tu Grupo</label>
                <select id="grupo" onchange="saveConfig()">
                    <option value="A">Grupo A</option>
                    <option value="B">Grupo B</option>
                    <option value="C">Grupo C</option>
                    <option value="D">Grupo D</option>
                </select>
            </div>
            <div style="flex: 1.5;">
                <label>Tu 1er dÃ­a de trabajo</label>
                <input type="date" id="inicioGrupo" onchange="saveConfig()">
            </div>
        </div>
        <p style="font-size: 0.55rem; margin: 5px 0 0; color: #666;">* Configura esto una sola vez para ajustar tu ciclo.</p>
    </div>

    <div class="form-group">
        <label>Colaborador</label>
        <input type="text" id="nombre" placeholder="Nombre completo" oninput="saveConfig()">
    </div>

    <div class="form-group" style="display: flex; gap: 8px;">
        <div style="flex: 1;"><label>Sistema</label><select id="sistema" onchange="calcular()"><option value="4">4x4</option><option value="7">7x7</option><option value="10" selected>10x10</option><option value="14">14x14</option></select></div>
        <div style="flex: 1;"><label>Fecha a Consultar</label><input type="date" id="fechaBusqueda" onchange="calcular()"></div>
    </div>

    <div class="info-grid">
        <div class="widget" id="contadorBajada">-</div>
        <div class="widget" id="fechaEspecial">-</div>
    </div>

    <div id="resultado" class="result-box"></div>

    <label>Ciclo actual de 10 dÃ­as:</label>
    <div class="mini-calendar" id="miniCalendar"></div>

    <button class="btn btn-pdf" onclick="descargarPDF()">ðŸ“„ PDF</button>
    <button class="btn btn-ws" onclick="compartirWhatsApp()">ðŸ’¬ WhatsApp</button>

    <div class="footer">
        <strong>@Otherbabu.u 2025</strong> | ICV Faena
    </div>
</div>

<script>
    function loadPhoto(event) {
        const reader = new FileReader();
        reader.onload = function() {
            document.getElementById('profileDisplay').src = reader.result;
            localStorage.setItem('userPhoto', reader.result);
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    function saveConfig() {
        localStorage.setItem('grupo', document.getElementById('grupo').value);
        localStorage.setItem('inicioGrupo', document.getElementById('inicioGrupo').value);
        localStorage.setItem('nombreUser', document.getElementById('nombre').value);
        calcular();
    }

    window.onload = function() {
        // Cargar datos guardados
        if(localStorage.getItem('userPhoto')) document.getElementById('profileDisplay').src = localStorage.getItem('userPhoto');
        if(localStorage.getItem('grupo')) document.getElementById('grupo').value = localStorage.getItem('grupo');
        if(localStorage.getItem('inicioGrupo')) document.getElementById('inicioGrupo').value = localStorage.getItem('inicioGrupo');
        if(localStorage.getItem('nombreUser')) document.getElementById('nombre').value = localStorage.getItem('nombreUser');
        
        // Fecha por defecto hoy
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fechaBusqueda').value = hoy;
        
        calcular();
    };

    function calcular() {
        const fechaInicio = document.getElementById('inicioGrupo').value;
        const fechaBusca = document.getElementById('fechaBusqueda').value;
        const sistema = parseInt(document.getElementById('sistema').value);
        
        if (!fechaInicio || !fechaBusca) return;

        const inicio = new Date(fechaInicio + "T12:00:00");
        const busca = new Date(fechaBusca + "T12:00:00");
        
        const diff = Math.floor((busca - inicio) / (1000*60*60*24));
        const cicloTotal = sistema * 4;
        let pos = diff % cicloTotal;
        if (pos < 0) pos += cicloTotal;

        const resDiv = document.getElementById('resultado');
        resDiv.style.display = "block";

        if (pos < sistema) {
            actualizarUI("TURNO DÃA â˜€ï¸", "#fff3e0", "#ef6c00", "#ff9800");
            document.getElementById('contadorBajada').innerText = `Bajas en: ${sistema - pos} dÃ­as`;
        } else if (pos < sistema * 2) {
            actualizarUI("DÃA LIBRE ðŸ ", "#e8f5e9", "#2e7d32", "#4caf50");
            document.getElementById('contadorBajada').innerText = `Subes en: ${(sistema * 2) - pos} dÃ­as`;
        } else if (pos < sistema * 3) {
            actualizarUI("TURNO NOCHE ðŸŒ™", "#e8eaf6", "#283593", "#3f51b5");
            document.getElementById('contadorBajada').innerText = `Bajas en: ${(sistema * 3) - pos} dÃ­as`;
        } else {
            actualizarUI("DÃA LIBRE ðŸ ", "#e8f5e9", "#2e7d32", "#4caf50");
            document.getElementById('contadorBajada').innerText = `Subes en: ${(sistema * 4) - pos} dÃ­as`;
        }

        const miniCal = document.getElementById('miniCalendar');
        miniCal.innerHTML = "";
        let inicioBloquePos = Math.floor(pos / sistema) * sistema;
        for (let i = 0; i < sistema; i++) {
            const cPos = (inicioBloquePos + i) % cicloTotal;
            const d = document.createElement('div');
            d.className = "day-box"; d.innerText = i+1;
            if (cPos < sistema) d.style.backgroundColor = "#ff9800";
            else if (cPos < sistema * 2) d.style.backgroundColor = "#4caf50";
            else if (cPos < sistema * 3) d.style.backgroundColor = "#3f51b5";
            else d.style.backgroundColor = "#4caf50";
            if ((inicioBloquePos + i) === pos) d.style.border = "2px solid #333";
            miniCal.appendChild(d);
        }
    }

    function actualizarUI(t, b, c, br) { const r = document.getElementById('resultado'); r.innerText = t; r.style.backgroundColor = b; r.style.color = c; r.style.borderColor = br; }
    
    function descargarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("REPORTE DE TURNO - ICV", 10, 10);
        doc.text("Trabajador: " + document.getElementById('nombre').value, 10, 20);
        doc.text("Fecha: " + document.getElementById('fechaBusqueda').value, 10, 30);
        doc.text("Estado: " + document.getElementById('resultado').innerText, 10, 40);
        doc.save("MiTurno.pdf");
    }

    function compartirWhatsApp() {
        const msj = encodeURIComponent(`*Turno ICV*\n${document.getElementById('nombre').value}\nFecha: ${document.getElementById('fechaBusqueda').value}\nEstado: *${document.getElementById('resultado').innerText}*`);
        window.open(`https://api.whatsapp.com/send?text=${msj}`);
    }
</script>
</body>
</html>
